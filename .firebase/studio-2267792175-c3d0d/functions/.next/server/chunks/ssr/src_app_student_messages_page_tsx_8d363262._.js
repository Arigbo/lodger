module.exports=[87564,a=>{"use strict";var b=a.i(87924),c=a.i(72131),d=a.i(50944),e=a.i(23690),f=a.i(92759),g=a.i(87532),h=a.i(63588),i=a.i(79360),j=a.i(210),k=a.i(94183);a.i(79597);var l=a.i(36505),m=a.i(73810),n=a.i(28137);a.i(69387);var o=a.i(60574),p=a.i(42816),q=a.i(48711),r=a.i(91119),s=a.i(66718),t=a.i(72233),u=a.i(99570),v=a.i(72228),w=a.i(10738),x=a.i(29587),y=a.i(35732);function z(){let{user:a,isUserLoading:z}=(0,l.useUser)(),A=(0,l.useFirestore)(),B=(0,d.useRouter)(),C=(0,d.usePathname)(),D=(0,d.useSearchParams)(),[E,F]=(0,c.useState)(!1),[G,H]=(0,c.useState)([]),[I,J]=(0,c.useState)(null),[K,L]=(0,c.useState)(!1),[M,N]=(0,c.useState)(!0),[O,P]=(0,c.useState)(""),[Q,R]=(0,c.useState)(""),[S,T]=(0,c.useState)(null),[U,V]=(0,c.useState)(!0),W=(0,c.useRef)(null),X=()=>{W.current?.scrollIntoView({behavior:"smooth"})},Y=D.get("conversationId"),Z=D.get("contact");(0,c.useEffect)(()=>{(Y||Z)&&V(!1)},[Y,Z]);let{data:$}=(0,n.useDoc)((0,l.useMemoFirebase)(()=>Z?(0,o.doc)(A,"users",Z):null,[Z,A])),_=(0,l.useMemoFirebase)(()=>a?(0,o.doc)(A,"users",a.uid):null,[a,A]),{data:aa}=(0,n.useDoc)(_);(0,c.useEffect)(()=>{L(!0)},[]);let ab=(0,l.useMemoFirebase)(()=>a?(0,o.query)((0,o.collection)(A,"messages"),(0,o.where)("participantIds","array-contains",a.uid)):null,[A,a]),{data:ac,isLoading:ad}=(0,m.useCollection)(ab);(0,c.useEffect)(()=>{z||ad||(a?(async()=>{N(!0);let b=new Map;(ac||[]).forEach(c=>{let d=c.participantIds.find(b=>b!==a.uid);d&&(!b.has(d)||c.timestamp&&b.get(d).lastMessage.timestamp&&c.timestamp.toMillis()>b.get(d).lastMessage.timestamp.toMillis())&&b.set(d,{lastMessage:c,participantId:d})});let c=new Set(Array.from(b.keys())),d=(0,o.query)((0,o.collection)(A,"properties"),(0,o.where)("currentTenantId","==",a.uid),(0,o.limit)(1)),e=await (0,o.getDocs)(d);if(!e.empty){let a=e.docs[0].data();c.add(a.landlordId)}if($&&c.add($.id),0===c.size){H([]),N(!1);return}let f=Array.from(c),g=(0,o.query)((0,o.collection)(A,"users"),(0,o.where)((0,o.documentId)(),"in",f)),h=await (0,o.getDocs)(g),i=new Map;h.forEach(a=>i.set(a.id,{id:a.id,...a.data()}));let j=f.map(c=>{let d=i.get(c);if(!d)return null;let e=b.get(c),f=(ac||[]).filter(b=>b.participantIds.includes(c)&&!1===b.read&&b.senderId!==a.uid).length;return{id:c,participant:d,otherUser:d,lastMessage:e?.lastMessage||null,lastMessageTimestamp:e?.lastMessage.timestamp?.toDate()||new Date(0),unreadCount:f}}).filter(Boolean);j.sort((a,b)=>(b.lastMessageTimestamp?.getTime()||0)-(a.lastMessageTimestamp?.getTime()||0)),H(j),N(!1)})():N(!1))},[a,A,$,z,ac,ad]);let ae=(0,c.useMemo)(()=>ac&&I?ac.filter(a=>a.participantIds.includes(I.id)).sort((a,b)=>a.timestamp&&b.timestamp?a.timestamp.toMillis()-b.timestamp.toMillis():0):[],[ac,I]);(0,c.useEffect)(()=>{if(Y){let a=G.find(a=>a.id===Y)?.participant;a&&(J(a),T(Y))}else Z&&$&&(J($),T(Z))},[Y,Z,G,$]),(0,c.useEffect)(()=>{a&&I&&A&&ac&&(async()=>{let a=ac.filter(a=>a.participantIds.includes(I.id)&&!1===a.read&&a.senderId===I.id);if(0===a.length)return;let b=(0,o.writeBatch)(A);a.forEach(a=>{let c=(0,o.doc)(A,"messages",a.id);b.update(c,{read:!0})});try{await b.commit()}catch(a){console.error("Error marking messages as read:",a)}})()},[I,a,A,ac]),(0,c.useEffect)(()=>{W.current&&X()},[ae]);let af=G.find(a=>a.id===S),ag=G.filter(a=>a.participant.name?.toLowerCase().includes(O.toLowerCase()));return z||M?(0,b.jsx)(p.default,{}):(0,b.jsxs)("div",{className:"flex h-[calc(100dvh-7rem)] md:h-[calc(100vh-8rem)] gap-0 md:gap-8 animate-in fade-in duration-700 overflow-hidden -mt-4 md:mt-0",children:[(0,b.jsxs)("div",{className:(0,e.cn)("w-full md:w-80 lg:w-96 flex-shrink-0 flex flex-col gap-4 md:gap-6 transition-all duration-300",!U&&"hidden md:flex"),children:[(0,b.jsxs)("div",{className:"px-2",children:[(0,b.jsxs)("h1",{className:"text-2xl md:text-3xl font-black uppercase tracking-tight",children:["Messages",(0,b.jsx)("span",{className:"text-primary",children:"."})]}),(0,b.jsx)("p",{className:"text-[10px] md:text-sm font-medium text-muted-foreground mt-1 text-left",children:"Your direct connection to landlords."})]}),(0,b.jsxs)(r.Card,{className:"flex-1 flex flex-col rounded-[2rem] md:rounded-[2.5rem] border-2 border-white/40 shadow-xl shadow-black/[0.02] overflow-hidden bg-white/60 backdrop-blur-xl",children:[(0,b.jsx)("div",{className:"p-6 border-b border-muted/20",children:(0,b.jsxs)("div",{className:"relative group",children:[(0,b.jsx)(g.Search,{className:"absolute left-4 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground/40 group-focus-within:text-primary transition-colors"}),(0,b.jsx)(s.Input,{placeholder:"Search conversations...",className:"pl-12 h-12 rounded-2xl border-none bg-muted/20 focus:bg-white focus:ring-4 focus:ring-primary/10 transition-all font-bold",value:O,onChange:a=>P(a.target.value)})]})}),(0,b.jsx)("div",{className:"flex-1 overflow-y-auto custom-scrollbar p-2",children:M?(0,b.jsx)("div",{className:"space-y-4 p-4",children:[1,2,3].map(a=>(0,b.jsxs)("div",{className:"flex gap-4 items-center animate-pulse",children:[(0,b.jsx)("div",{className:"h-14 w-14 rounded-2xl bg-muted/40"}),(0,b.jsxs)("div",{className:"flex-1 space-y-2",children:[(0,b.jsx)("div",{className:"h-4 w-1/2 bg-muted/40 rounded-full"}),(0,b.jsx)("div",{className:"h-3 w-3/4 bg-muted/40 rounded-full"})]})]},a))}):0===ag.length?(0,b.jsxs)("div",{className:"flex flex-col items-center justify-center h-full p-8 text-center space-y-4",children:[(0,b.jsx)("div",{className:"h-16 w-16 rounded-2xl bg-muted/20 flex items-center justify-center",children:(0,b.jsx)(h.MessageSquare,{className:"h-8 w-8 text-muted-foreground/20"})}),(0,b.jsx)("p",{className:"text-sm font-black text-muted-foreground uppercase tracking-widest leading-relaxed",children:"No conversations found"})]}):ag.map(c=>{let d=c.unreadCount>0;return(0,b.jsxs)("button",{onClick:()=>{T(c.id),V(!1),B.replace(`${C}?conversationId=${c.id}`,{scroll:!1})},className:(0,e.cn)("w-full flex gap-4 items-center p-3 md:p-4 rounded-2xl md:rounded-3xl transition-all duration-300 border-2 relative",S===c.id?"bg-white border-primary/10 shadow-lg scale-[1.02]":d?"bg-primary/5 border-primary/20 hover:bg-primary/10 hover:border-primary/30":"border-transparent hover:bg-white/40 hover:border-white/60 grayscale-[0.5] hover:grayscale-0"),children:[(0,b.jsxs)("div",{className:"relative",children:[(0,b.jsxs)(t.Avatar,{className:"h-14 w-14 rounded-2xl border-2 border-background shadow-sm",children:[(0,b.jsx)(t.AvatarImage,{src:c.otherUser?.profileImageUrl,className:"object-cover"}),(0,b.jsx)(t.AvatarFallback,{className:(0,e.cn)("text-xl font-black",d?"bg-primary/10 text-primary":"bg-primary/5 text-primary"),children:c.otherUser?.name?.[0]||"U"})]}),d&&(0,b.jsx)("div",{className:"absolute -top-1 -right-1 h-5 w-5 bg-primary rounded-full border-2 border-white flex items-center justify-center",children:(0,b.jsx)("span",{className:"text-[10px] font-black text-white",children:c.unreadCount})})]}),(0,b.jsxs)("div",{className:"flex-1 text-left min-w-0",children:[(0,b.jsxs)("div",{className:"flex justify-between items-start mb-0.5",children:[(0,b.jsx)("h3",{className:(0,e.cn)("font-black text-xs uppercase tracking-tight truncate pr-2",d&&"text-primary"),children:c.otherUser?.name||"Unknown User"}),(0,b.jsx)("span",{className:"text-[10px] font-bold text-muted-foreground/40 whitespace-nowrap",children:c.lastMessage?.timestamp?(0,w.formatDistanceToNow)(new Date(c.lastMessage.timestamp.toDate()),{addSuffix:!1}):""})]}),(0,b.jsxs)("p",{className:"text-xs font-medium truncate pr-4 leading-tight w-full overflow-hidden text-ellipsis whitespace-nowrap",children:[c.lastMessage?.senderId===a?.uid?"You: ":"",c.lastMessage?.text||"No messages yet"]})]})]},c.id)})})]})]}),(0,b.jsx)("div",{className:(0,e.cn)("flex-1 h-full",U&&"hidden md:block"),children:S?(0,b.jsxs)(r.Card,{className:"h-full flex flex-col rounded-none md:rounded-[3rem] border-0 md:border-2 border-white/40 shadow-2xl shadow-black/[0.03] bg-white overflow-hidden relative",children:[(0,b.jsxs)("div",{className:"p-4 md:p-8 border-b-2 border-muted/5 flex items-center justify-between bg-white text-left",children:[(0,b.jsxs)("div",{className:"flex items-center gap-3 md:gap-6",children:[(0,b.jsx)(u.Button,{variant:"ghost",size:"icon",className:"md:hidden h-10 w-10 rounded-xl",onClick:()=>{V(!0),B.replace(C,{scroll:!1})},children:(0,b.jsx)(j.ArrowLeft,{className:"h-5 w-5"})}),(0,b.jsxs)(t.Avatar,{className:"h-10 w-10 md:h-16 md:w-16 rounded-xl md:rounded-[1.25rem] border-2 border-primary/5 shadow-md",children:[(0,b.jsx)(t.AvatarImage,{src:af?.otherUser?.profileImageUrl,className:"object-cover"}),(0,b.jsx)(t.AvatarFallback,{className:"bg-muted text-xl md:text-2xl font-black",children:af?.otherUser?.name?.[0]})]}),(0,b.jsxs)("div",{className:"space-y-0.5",children:[(0,b.jsxs)("div",{className:"flex items-center gap-2 md:gap-3",children:[(0,b.jsx)("h2",{className:"text-base md:text-xl font-black uppercase tracking-tight leading-none truncate max-w-[150px] md:max-w-none",children:af?.otherUser?.name}),(0,b.jsx)("div",{className:"h-1 md:h-1.5 w-1 md:w-1.5 rounded-full bg-green-500 shadow-[0_0_12px_rgba(34,197,94,0.5)]"})]}),(0,b.jsx)("p",{className:"text-[7px] md:text-[10px] font-bold text-muted-foreground/40 uppercase tracking-[0.1em]",children:"Verified Landlord Connection"})]})]}),(0,b.jsx)("div",{className:"flex gap-2",children:(0,b.jsxs)(y.DropdownMenu,{children:[(0,b.jsx)(y.DropdownMenuTrigger,{asChild:!0,children:(0,b.jsx)(u.Button,{variant:"ghost",size:"icon",className:"h-10 w-10 md:h-12 md:w-12 rounded-xl md:rounded-2xl hover:bg-muted/30 transition-all text-muted-foreground",children:(0,b.jsx)(i.MoreVertical,{className:"h-5 w-5"})})}),(0,b.jsx)(y.DropdownMenuContent,{align:"end",className:"w-48 rounded-xl",children:(0,b.jsxs)(y.DropdownMenuItem,{className:"text-destructive focus:text-destructive focus:bg-destructive/10 font-bold cursor-pointer",onClick:()=>F(!0),children:[(0,b.jsx)(k.Flag,{className:"mr-2 h-4 w-4"}),"Report Landlord"]})})]})})]}),(0,b.jsxs)("div",{className:"flex-1 overflow-y-auto p-4 md:p-10 space-y-6 md:space-y-8 custom-scrollbar relative",children:[(0,b.jsx)("div",{className:"absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] bg-fixed opacity-[0.03] pointer-events-none"}),(0,b.jsxs)("div",{className:"relative z-10 space-y-6 md:space-y-8",children:[Object.entries(ae.reduce((a,b)=>{let c=(0,v.format)(b.timestamp?b.timestamp.toDate():new Date,"MMMM d, yyyy");return a[c]||(a[c]=[]),a[c].push(b),a},{})).map(([c,d])=>(0,b.jsxs)("div",{className:"space-y-8",children:[(0,b.jsxs)("div",{className:"flex justify-center py-4 relative",children:[(0,b.jsx)("div",{className:"absolute inset-x-0 top-1/2 h-px bg-muted/10"}),(0,b.jsx)("span",{className:"relative z-10 px-6 py-2 rounded-full bg-white border-2 border-muted/5 text-[10px] font-black uppercase tracking-[0.2em] shadow-sm",children:c})]}),d.map(c=>(0,b.jsxs)("div",{className:(0,e.cn)("flex gap-4 max-w-[85%] animate-in slide-in-from-bottom-2 duration-500",c.senderId===a?.uid?"ml-auto flex-row-reverse":"mr-auto"),children:[(0,b.jsxs)(t.Avatar,{className:"h-10 w-10 flex-shrink-0 rounded-xl mt-1 shadow-sm border-2 border-white",children:[(0,b.jsx)(t.AvatarImage,{src:c.senderId===a?.uid?aa?.profileImageUrl:I?.profileImageUrl,className:"object-cover"}),(0,b.jsx)(t.AvatarFallback,{className:"text-[10px] font-black",children:c.senderId===a?.uid?"ME":"U"})]}),(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsx)("div",{className:(0,e.cn)("p-6 rounded-[2rem] text-sm font-medium leading-relaxed shadow-xl transition-all hover:scale-[1.01]",c.senderId===a?.uid?"bg-foreground text-white rounded-tr-none shadow-black/10":"bg-white border-2 border-muted/10 text-foreground rounded-tl-none shadow-black/5"),children:c.text}),(0,b.jsxs)("p",{className:(0,e.cn)("text-[8px] font-bold text-muted-foreground/30 uppercase tracking-widest",c.senderId===a?.uid?"text-right":"text-left"),children:[(0,v.format)(c.timestamp?c.timestamp.toDate():new Date,"HH:mm")," â€¢ ",c.senderId===a?.uid?"Delivered":"Received"]})]})]},c.id))]},c)),(0,b.jsx)("div",{ref:W})]})]}),(0,b.jsx)("div",{className:"p-4 md:p-8 border-t-2 border-muted/5 bg-white relative",children:(0,b.jsxs)("form",{onSubmit:b=>{b.preventDefault(),(()=>{if(!Q.trim()||!a||!I||!A)return;let b=(0,o.collection)(A,"messages"),c={text:Q,senderId:a.uid,recipientId:I.id,participantIds:[a.uid,I.id].sort(),timestamp:(0,o.serverTimestamp)(),read:!1};(0,o.addDoc)(b,c).then(()=>(R(""),X(),(0,q.sendNotification)({toUserId:I.id,type:"NEW_MESSAGE",firestore:A,senderName:a.displayName||"Tenant",customMessage:Q,link:`/landlord/messages?conversationId=${a.uid}`}))).catch(a=>{console.error("FAILED_TO_SEND_MESSAGE",a),alert(`Failed to send message: ${a.message||"Unknown error"}`)})})()},className:"relative",children:[(0,b.jsx)(s.Input,{placeholder:"Draft your message...",className:"h-14 md:h-20 rounded-2xl md:rounded-[2.5rem] border-2 bg-muted/5 pl-6 md:pl-8 pr-20 md:pr-28 text-sm font-medium focus:bg-white focus:ring-8 focus:ring-primary/5 transition-all shadow-inner placeholder:text-muted-foreground/40",value:Q,onChange:a=>R(a.target.value)}),(0,b.jsx)(u.Button,{type:"submit",className:"absolute right-2 top-1/2 -translate-y-1/2 h-10 md:h-14 px-4 md:px-8 rounded-xl md:rounded-full bg-primary hover:bg-primary/90 text-white shadow-xl shadow-primary/20 transition-all active:scale-95 disabled:opacity-50 disabled:scale-100",disabled:!Q.trim(),children:(0,b.jsx)(f.Send,{className:"h-4 w-4 md:h-5 md:w-5"})})]})})]}):(0,b.jsxs)(r.Card,{className:"h-full flex flex-col items-center justify-center rounded-[2rem] md:rounded-[3rem] border-2 border-dashed border-muted/10 bg-muted/5 p-8 md:p-20 text-center space-y-6 md:space-y-8 animate-in zoom-in duration-700",children:[(0,b.jsxs)("div",{className:"h-20 w-20 md:h-32 md:w-32 rounded-2xl md:rounded-[2.5rem] bg-white shadow-2xl flex items-center justify-center mx-auto relative group overflow-hidden",children:[(0,b.jsx)("div",{className:"absolute inset-0 bg-primary/5 rounded-2xl md:rounded-[2.5rem] animate-pulse"}),(0,b.jsx)(h.MessageSquare,{className:"h-8 w-8 md:h-14 md:w-14 text-muted-foreground/20 group-hover:scale-110 transition-transform duration-500"})]}),(0,b.jsxs)("div",{className:"space-y-2 md:space-y-3",children:[(0,b.jsxs)("h3",{className:"text-xl md:text-3xl font-black uppercase tracking-tight",children:["Channel ",(0,b.jsx)("span",{className:"text-primary",children:"Hibernated"})]}),(0,b.jsx)("p",{className:"text-sm md:text-lg text-muted-foreground font-medium max-w-sm mx-auto leading-relaxed",children:"Select a landlord thread to initiate communication."})]})]})}),af&&af.otherUser&&(0,b.jsx)(x.ReportUserDialog,{isOpen:E,onClose:()=>F(!1),reportedUserId:af.otherUser.id,reportedUserName:af.otherUser.name})]})}a.s(["default",()=>z])}];

//# sourceMappingURL=src_app_student_messages_page_tsx_8d363262._.js.map