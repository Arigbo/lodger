{"version":3,"sources":["../../../../src/firebase/storage.ts"],"sourcesContent":["\"use client\";\r\n\r\nimport {\r\n  FirebaseStorage,\r\n  ref,\r\n  uploadBytes,\r\n  getDownloadURL,\r\n} from \"firebase/storage\";\r\n\r\n/**\r\n * Type definition for image moderation analysis results\r\n */\r\nexport interface ModerationAnalysis {\r\n  safety: \"SAFE\" | \"UNSAFE\";\r\n  context: \"RELEVANT\" | \"IRRELEVANT\";\r\n  labels?: string[];\r\n  reason?: string;\r\n  cached?: boolean;\r\n}\r\n\r\n/**\r\n * Result of moderation and upload operation\r\n */\r\nexport interface ModerationUploadResult {\r\n  success: boolean;\r\n  downloadURL?: string;\r\n  analysis?: ModerationAnalysis;\r\n  error?: string;\r\n  blocked?: boolean;\r\n}\r\n\r\n/**\r\n * Moderates an image using the API before uploading\r\n * @param imageFile The image file to moderate and upload\r\n * @returns Moderation analysis result\r\n */\r\nexport async function moderateImage(\r\n  imageFile: File\r\n): Promise<ModerationAnalysis> {\r\n  // Convert file to base64\r\n  const base64 = await new Promise<string>((resolve, reject) => {\r\n    const reader = new FileReader();\r\n    reader.onloadend = () => {\r\n      const result = reader.result as string;\r\n      resolve(result.split(',')[1]);\r\n    };\r\n    reader.onerror = reject;\r\n    reader.readAsDataURL(imageFile);\r\n  });\r\n\r\n  // Call moderation API\r\n  const response = await fetch('/api/moderate-image', {\r\n    method: 'POST',\r\n    headers: { 'Content-Type': 'application/json' },\r\n    body: JSON.stringify({\r\n      imageBase64: base64,\r\n      mimeType: imageFile.type\r\n    })\r\n  });\r\n\r\n  if (!response.ok) {\r\n    if (response.status === 429) {\r\n      throw new Error('Rate limit exceeded. Please wait and try again.');\r\n    }\r\n    throw new Error('Moderation check failed');\r\n  }\r\n\r\n  return await response.json();\r\n}\r\n\r\n/**\r\n * Moderates and uploads an image to Firebase Storage\r\n * @param storage The Firebase Storage instance\r\n * @param path The storage path for the image\r\n * @param file The image file to upload\r\n * @param options Optional configuration\r\n * @returns Result object with download URL or error\r\n */\r\nexport async function moderateAndUpload(\r\n  storage: FirebaseStorage,\r\n  path: string,\r\n  file: File,\r\n  options?: {\r\n    allowIrrelevant?: boolean; // Allow upload even if context is IRRELEVANT\r\n    skipModeration?: boolean; // Skip moderation entirely (not recommended)\r\n  }\r\n): Promise<ModerationUploadResult> {\r\n  try {\r\n    // Validate file type\r\n    if (!file.type.startsWith(\"image/\")) {\r\n      return {\r\n        success: false,\r\n        error: \"Invalid file type. Please upload an image file.\",\r\n      };\r\n    }\r\n\r\n    // Validate file size (5MB limit)\r\n    if (file.size > 5 * 1024 * 1024) {\r\n      return {\r\n        success: false,\r\n        error: \"File is too large. Maximum size is 5MB.\",\r\n      };\r\n    }\r\n\r\n    // Skip moderation if explicitly requested (not recommended for production)\r\n    if (options?.skipModeration) {\r\n      const storageRef = ref(storage, path);\r\n      const metadata = {\r\n        contentType: file.type,\r\n        cacheControl: 'public, max-age=3600'\r\n      };\r\n      const snapshot = await uploadBytes(storageRef, file, metadata);\r\n      const downloadURL = await getDownloadURL(snapshot.ref);\r\n      return { success: true, downloadURL };\r\n    }\r\n\r\n    // Moderate the image\r\n    const analysis = await moderateImage(file);\r\n\r\n    // Block UNSAFE images\r\n    if (analysis.safety === \"UNSAFE\") {\r\n      return {\r\n        success: false,\r\n        blocked: true,\r\n        analysis,\r\n        error: analysis.reason || \"Image contains inappropriate content and cannot be uploaded.\",\r\n      };\r\n    }\r\n\r\n    // Optionally block IRRELEVANT images\r\n    if (analysis.context === \"IRRELEVANT\" && !options?.allowIrrelevant) {\r\n      return {\r\n        success: false,\r\n        blocked: false,\r\n        analysis,\r\n        error: analysis.reason || \"Image may not be relevant to property listings.\",\r\n      };\r\n    }\r\n\r\n    // Upload the image\r\n    const storageRef = ref(storage, path);\r\n    const metadata = {\r\n      contentType: file.type,\r\n      cacheControl: 'public, max-age=3600',\r\n      customMetadata: {\r\n        moderationSafety: analysis.safety,\r\n        moderationContext: analysis.context,\r\n      }\r\n    };\r\n\r\n    const snapshot = await uploadBytes(storageRef, file, metadata);\r\n    const downloadURL = await getDownloadURL(snapshot.ref);\r\n\r\n    return {\r\n      success: true,\r\n      downloadURL,\r\n      analysis,\r\n    };\r\n  } catch (error: any) {\r\n    console.error(\"Moderation and upload error:\", error);\r\n    return {\r\n      success: false,\r\n      error: error.message || \"Upload failed. Please try again.\",\r\n    };\r\n  }\r\n}\r\n\r\n/**\r\n * Uploads a profile image for a user and returns the download URL.\r\n * @param storage The Firebase Storage instance.\r\n * @param userId The ID of the user.\r\n * @param file The image file to upload.\r\n * @returns A promise that resolves with the public download URL of the uploaded image.\r\n */\r\nexport async function uploadProfileImage(\r\n  storage: FirebaseStorage,\r\n  userId: string,\r\n  file: File\r\n): Promise<string> {\r\n  try {\r\n    // Validate file before upload\r\n    if (!file.type.startsWith(\"image/\")) {\r\n      throw new Error(\"Invalid file type. Please upload an image file.\");\r\n    }\r\n\r\n    if (file.size > 5 * 1024 * 1024) { // Increased limit to 5MB based on typical user behavior\r\n      throw new Error(\"File is too large. Maximum size is 5MB.\");\r\n    }\r\n\r\n    // Use a fixed filename but include metadata to ensure correct MIME type\r\n    const storageRef = ref(storage, `users/${userId}/profile-picture`);\r\n\r\n    const metadata = {\r\n      contentType: file.type,\r\n      cacheControl: 'public, max-age=3600'\r\n    };\r\n\r\n    // Upload the file\r\n    console.log(\r\n      `Starting upload for user ${userId}, file: ${file.name}, size: ${file.size}, type: ${file.type}`\r\n    );\r\n    const snapshot = await uploadBytes(storageRef, file, metadata);\r\n    console.log(\"Upload successful, retrieving download URL...\");\r\n\r\n    // Get the download URL\r\n    const downloadURL = await getDownloadURL(snapshot.ref);\r\n    console.log(\"Download URL retrieved successfully\");\r\n\r\n    return downloadURL;\r\n  } catch (error: any) {\r\n    console.error(\"Profile image upload error:\", {\r\n      code: error.code,\r\n      message: error.message,\r\n      serverResponse: error.serverResponse,\r\n      fullError: error,\r\n    });\r\n    throw new Error(`Upload failed: ${error.message || \"Unknown error\"}`);\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}